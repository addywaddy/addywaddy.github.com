---
layout:     post
title:      Array Aggregation in PostgreSQL
date:       2015-08-31
summary:    Now, Pixyll is lighter weight and more customizable than before.
categories: postgres
---

So you have two tables\: posts and comments. Posts can have many comments:

    Posts              Comments
    +----+---------+   +----+---------+
    | id | title   |   | id | post_id |
    +----+---------+   |----|---------|
    |  1 | Post 1  |   |  1 |      1  |
    |  2 | Post 2  |   |  2 |      1  |
    |  3 | Post 3  |   |  3 |      2  |
    |  4 | Post 4  |   |  4 |      3  |
    |  5 | Post 5  |   |  5 |      3  |
    +----+---------+   |  6 |      4  |
                       |  7 |      5  |
                       |  8 |      5  |
                       |  9 |      5  |
                       +----+---------+

How do you write a query which will return a list of all posts with title and an array of comment ids?

{% highlight sql %}
SELECT title, comments.id AS comment_ids
FROM posts INNER JOIN comments ON posts.id = comments.post_id;
{% endhighlight %}

Should work right? Wrong:

    +--------+-------------+
    | title  | comment_ids |
    +--------+-------------+
    | Post 1 |           1 |
    | Post 1 |           2 |
    | Post 2 |           3 |
    | Post 3 |           4 |
    | Post 3 |           5 |
    | Post 4 |           6 |
    | Post 5 |           7 |
    | Post 5 |           8 |
    | Post 5 |           9 |
    +--------+-------------+

How can we get a list of distinct post titles with their comment ids? Maybe with distinct?

{% highlight sql %}
SELECT DISTINCT ON (title) title, comments.id AS comment_ids
FROM posts INNER JOIN comments ON posts.id = comments.post_id;
{% endhighlight %}

Nope.

    +--------+-------------+
    | title  | comment_ids |
    +--------+-------------+
    | Post 1 |           1 |
    | Post 2 |           3 |
    | Post 3 |           4 |
    | Post 4 |           6 |
    | Post 5 |           7 |
    +--------+-------------+

Bah. There must be a way. We want to collect a list of comment ids for each post and pack them in our comments_ids column, as an array. We want to collect, or aggregate, an array of comment ids.

From the PostgreSQL manual:

> Aggregate functions compute a single result from a set of input values.

And there it is: `array_agg`. Behold:

{% highlight sql %}
SELECT title, array_agg(comments.id) AS comment_ids
FROM posts INNER JOIN comments ON posts.id = comments.post_id
GROUP BY posts.title;
{% endhighlight %}

That's more like it :)

    +--------+-------------+
    | title  | comment_ids |
    +--------+-------------+
    | Post 1 | {1,2}       |
    | Post 2 | {3}         |
    | Post 3 | {4,5}       |
    | Post 4 | {6}         |
    | Post 5 | {7,8,9}     |
    +--------+-------------+
